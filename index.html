<!doctype html>
<html>

<head>

    <title>I/O Blocks</title>

    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script type="text/javascript" src="bower_components/webcomponentsjs/webcomponents.js"></script>

    <link rel="import" href="bower_components/polymer/polymer.html">
    <link rel="import" href="bower_components/font-roboto/roboto.html">
    <link rel="import" href="bower_components/core-icons/core-icons.html">
    <link rel="import" href="bower_components/core-toolbar/core-toolbar.html">
    <link rel="import" href="bower_components/core-drawer-panel/core-drawer-panel.html">
    <link rel="import" href="bower_components/core-header-panel/core-header-panel.html">
    <link rel="import" href="bower_components/core-icon-button/core-icon-button.html">
    <link rel="import" href="bower_components/core-drag-drop/core-drag-drop.html">
    <link rel="import" href="bower_components/paper-fab/paper-fab.html">
    <link rel="import" href="components/io-block.html">
    <link rel="import" href="components/io-block-add.html">
    <link rel="import" href="components/io-block-supplier.html">
    <link rel="import" href="components/io-block-display.html">
    <link rel="import" href="components/io-wire.html">

    <style>

    * {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
    }

    html,body {
        height: 100%;
        margin: 0;
        background-color: #E5E5E5;
        font-family: 'RobotoDraft', sans-serif;
    }

    #app {

    }

    #app #menu {
        background-color: #FFF;
    }

/*    #app #menu #mainContainer {
        overflow-x: auto;
    }*/

    #app #content core-toolbar {
        background-color: #657ACF;
    }

    #app #content #canvas {
        width: 100%;
        height: 100%;
        position: absolute;
    }

    #add-action {
        position: absolute;
        bottom: 25px;
        right: 25px;
        z-index: 100;
    }

    </style>

</head>

<body unresolved>

    <core-drawer-panel id="app" forceNarrow="true">
        <core-header-panel id="menu" drawer>
            <core-toolbar>
                <div>Menu</div>
            </core-toolbar>
        </core-header-panel>
        <core-header-panel id="content" main>
            <core-toolbar>
                <core-icon-button icon="menu" core-drawer-toggle></core-icon-button>
                <div>IO Blocks</div>
                <core-icon-button icon="face"></core-icon-button>
            </core-toolbar>
            <div id="canvas">
                <core-drag-drop></core-drag-drop>

                <!--<io-wire id="w1"></io-wire>
                <io-wire id="w2"></io-wire>
                <io-wire id="w3"></io-wire>
                <io-wire id="w4"></io-wire>-->
 
                <io-block
                    x="100"
                    y="100"
                    id="s1">
                    <io-block-supplier></io-block-supplier>
                </io-block>

                <io-block
                    id="d1"
                    x="100"
                    y="290">
                    <io-block-display></io-block-display>
                </io-block>

                <io-block
                    id="s3"
                    x="100"
                    y="500">
                    <io-block-supplier></io-block-supplier>
                </io-block>

                <io-block
                    x="400"
                    y="150"
                    id="c1">
                    <io-block-add></io-block-add>
                </io-block>

                <!--<io-block
                    id="c2"
                    x="400"
                    y="400"
                    icount = "2">
                </io-block>

                <io-block
                    id="c3"
                    x="650"
                    y="300"
                    icount = "2">
                </io-block>-->

            </div>
        </core-header-panel>
    </core-drawer-panel>

    <paper-fab id="add-action" icon="add" onclick="Manager.addBlock();" ></paper-fab>

    <script>

        var i = 10, j = 10;

        var IO = {
            pattern: /([iI|oO])(\d+)/,

            getIndex: function (ref) {
                var matches, parsed;
                if (typeof ref === "number") {
                    return ref;
                } else if (!isNaN(parsed = parseInt(ref))) {
                    return parsed;
                } else if ((matches = ref.match(IO.pattern)) && matches.length === 3) {
                    return matches[2];
                } else {
                    return undefined;
                }
            },

            getType: function (ref) {
                var matches;
                if ((matches = ref.match(IO.pattern)) && matches.length === 3) {
                    return matches[1];
                } else {
                    return undefined;
                }
            },

            isInput: function (ref) {
                return IO.getType(ref).match(/[iI]/g);
            },

            isOutput: function (ref) {
                return IO.getType(ref).match(/[oO]/g);
            }
        }

        var Behaviors = {
            supply: function (value) {
                return function () {
                    return [value];
                }
            },
            and: function (values) {
                return [values[0] && values[1]];
            },
            or: function (values) {
                return [values[0] || values[1]];
            },
            multiply: function (values) {
                return [values[0] * values[1]];
            },
            sum: function (values) {
                return [values[0] + values[1]];
            },
            substract: function (values) {
                return [values[0] - values[1]];
            },
            divide: function (values) {
                return [values[0] / values[1]];
            },
        };

        var Manager = {
            currentWire: undefined,
            addBlock: function() {
                var block = document.createElement('io-block');
                var canvas = document.querySelector('#canvas');

                block.setAttribute('id', 'b' + i);
                block.setAttribute('name', 'b' + i);
                block.setAttribute('icount', 1);
                block.setAttribute('ocount', 1);

                canvas.appendChild(block);

                i++;
                return block;
            },

            beginAddWire: function() {
                var canvas = document.querySelector('#canvas');

                var wire = document.createElement('io-wire');
                wire.setAttribute('id', 'w' + j);

                // Insert wire before block in the DOM (To set them in background ~ inferior z-index).
                if (canvas.firstChild) {
                    canvas.insertBefore(wire, canvas.firstChild);
                } else {
                    canvas.appendChild(wire);
                }

                Manager.currentWire = wire;
                j++;
                return wire;
            },

            endAddWire: function() {
                Manager.currentWire = undefined;
            },

            removeBlock: function(id) {
                var block = document.querySelector('#' + id);
                block.remove();
            },

            removeWire: function(id) {
                var wire = document.querySelector('#' + id);
                wire.remove();
            }
        }

        function drag(dragInfo) {
            var target = dragInfo.event.target;
            if (target) {
                var p = dragInfo.p, d = dragInfo.delta;
                target.x = p.x - d.x;
                target.y = p.y - d.y;
          }
        }

        function refresh() {
            document.querySelectorAll('io-wire').array().forEach(function (el) {
                el.positionChanged();
            });
        }

        addEventListener('drag-start', function(e) {
            var dragInfo = e.detail;
            var target = dragInfo.event.target;

            if (target.tagName.toLowerCase() === 'io-block') {
                dragInfo.drag = drag;
                dragInfo.delta = {
                    x: dragInfo.event.clientX - parseInt(target.x),
                    y: dragInfo.event.clientY - parseInt(target.y)
                };
            }
        });

        window.addEventListener('resize', refresh);

        window.addEventListener('polymer-ready', function(e) {
            // var w1 = document.querySelector('#w1');
            // var w2 = document.querySelector('#w2');
            // var w3 = document.querySelector('#w3');
            // var w4 = document.querySelector('#w4');
            // var s1 = document.querySelector('#s1');
            // var s2 = document.querySelector('#s2');
            // var s3 = document.querySelector('#s3');
            // var c1 = document.querySelector('#c1');
            // var c2 = document.querySelector('#c2');
            // var c3 = document.querySelector('#c3');

            // s1.computor = Behaviors.supply(1);
            // s2.computor = Behaviors.supply(2);
            // s3.computor = Behaviors.supply(3);
            // c1.computor = Behaviors.sum;
            // c2.computor = Behaviors.sum;
            // c3.computor = Behaviors.multiply;

            // w1.setInput(s1, 'o0', true);
            // w1.setOutput(c1, 'i0', true);

            // w2.setInput(s2, 'o0', true);
            // w2.setOutput(c1, 'i1', true);

            // w3.setInput(s3, 'o0', true);
            // w3.setOutput(c3, 'i1', true);

            // w4.setInput(c1, 'o0', true);
            // w4.setOutput(c3, 'i0', true);
        });
    </script>
</body>



</html>
